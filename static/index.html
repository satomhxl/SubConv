<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" href="/favicon.png">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.1/css/all.min.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SubConv</title>
  <!-- element css cdn, if you use custom theme, remove it. -->
  <!-- <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/element-plus/dist/index.css"
    /> -->
  <script type="module" crossorigin src="/assets/index-CHhnTzuz.js"></script>
  <link rel="stylesheet" crossorigin href="/assets/index-C8CYsfRt.css">
</head>

<body>
  <!-- Password Protection Overlay -->
  <div id="auth-overlay"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); z-index: 9999; justify-content: center; align-items: center;">
    <div
      style="background: white; padding: 40px; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 400px; width: 90%;">
      <h2 style="margin: 0 0 10px 0; color: #333; font-size: 24px; text-align: center;">ğŸ”’ è®¿é—®éªŒè¯</h2>
      <p style="margin: 0 0 24px 0; color: #666; text-align: center; font-size: 14px;">è¯·è¾“å…¥è®¿é—®å¯†ç </p>
      <input type="password" id="auth-password" placeholder="è¯·è¾“å…¥å¯†ç "
        style="width: 100%; padding: 12px 16px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; box-sizing: border-box; margin-bottom: 16px; outline: none; transition: border-color 0.3s;"
        onkeypress="if(event.key === 'Enter') document.getElementById('auth-submit').click()" />
      <div id="auth-error"
        style="display: none; color: #e53e3e; font-size: 14px; margin-bottom: 12px; text-align: center;"></div>
      <button id="auth-submit" onclick="submitPassword()"
        style="width: 100%; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;"
        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(102,126,234,0.4)'"
        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
        éªŒè¯
      </button>
    </div>
  </div>

  <script>
    // Authentication logic
    const AUTH_TOKEN_KEY = 'subconv_access_token';

    // Check if password protection is enabled and verify token
    async function checkAuth() {
      try {
        const token = localStorage.getItem(AUTH_TOKEN_KEY);
        const response = await fetch('/auth/check', {
          headers: token ? { 'X-Access-Token': token } : {}
        });
        const data = await response.json();

        if (!data.password_enabled) {
          // Password protection is disabled, hide overlay
          hideAuthOverlay();
          return true;
        }

        if (data.valid) {
          // Token is valid, hide overlay
          hideAuthOverlay();
          return true;
        } else {
          // Token is invalid or missing, show overlay
          showAuthOverlay();
          return false;
        }
      } catch (error) {
        console.error('Auth check failed:', error);
        showAuthOverlay();
        return false;
      }
    }

    function showAuthOverlay() {
      const overlay = document.getElementById('auth-overlay');
      overlay.style.display = 'flex';
      document.getElementById('auth-password').focus();
    }

    function hideAuthOverlay() {
      document.getElementById('auth-overlay').style.display = 'none';
    }

    async function submitPassword() {
      const password = document.getElementById('auth-password').value;
      const errorDiv = document.getElementById('auth-error');
      const submitBtn = document.getElementById('auth-submit');

      if (!password) {
        errorDiv.textContent = 'è¯·è¾“å…¥å¯†ç ';
        errorDiv.style.display = 'block';
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = 'éªŒè¯ä¸­...';
      errorDiv.style.display = 'none';

      try {
        const response = await fetch('/auth/verify', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ password: password })
        });

        const data = await response.json();

        if (data.success) {
          if (data.token) {
            localStorage.setItem(AUTH_TOKEN_KEY, data.token);
          }
          hideAuthOverlay();
          document.getElementById('auth-password').value = '';
        } else {
          errorDiv.textContent = 'å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•';
          errorDiv.style.display = 'block';
          document.getElementById('auth-password').value = '';
          document.getElementById('auth-password').focus();
        }
      } catch (error) {
        errorDiv.textContent = 'éªŒè¯å¤±è´¥ï¼Œè¯·é‡è¯•';
        errorDiv.style.display = 'block';
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'éªŒè¯';
      }
    }

    // Intercept fetch requests to add authentication token
    const originalFetch = window.fetch;
    window.fetch = function (...args) {
      const token = localStorage.getItem(AUTH_TOKEN_KEY);
      if (token && args[1]) {
        args[1].headers = args[1].headers || {};
        if (args[1].headers instanceof Headers) {
          args[1].headers.set('X-Access-Token', token);
        } else {
          args[1].headers['X-Access-Token'] = token;
        }
      } else if (token && !args[1]) {
        args[1] = { headers: { 'X-Access-Token': token } };
      }
      return originalFetch.apply(this, args);
    };

    // Intercept XMLHttpRequest to add authentication token
    const originalOpen = XMLHttpRequest.prototype.open;
    const originalSend = XMLHttpRequest.prototype.send;

    XMLHttpRequest.prototype.open = function (...args) {
      this._url = args[1];
      return originalOpen.apply(this, args);
    };

    XMLHttpRequest.prototype.send = function (...args) {
      const token = localStorage.getItem(AUTH_TOKEN_KEY);
      if (token) {
        this.setRequestHeader('X-Access-Token', token);
      }
      return originalSend.apply(this, args);
    };

    // Check authentication on page load
    // Only show overlay if we need to authenticate
    (function () {
      const token = localStorage.getItem(AUTH_TOKEN_KEY);
      if (!token) {
        // No token, show overlay immediately
        showAuthOverlay();
      }
      // Always check auth status with server
      checkAuth();
    })();
  </script>

  <div id="app"></div>
</body>

</html>